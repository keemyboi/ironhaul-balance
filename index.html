<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IRON HAUL — Credits Console</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://download.playfab.com/PlayFabClientApi.js"></script>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;background:#0a0f14;color:#d7e2ee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:920px;margin:48px auto;padding:0 20px}
    .panel{background:#101824;border:1px solid #1b2736;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);padding:22px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .title{letter-spacing:.08em;font-weight:800}
    .badge{font:12px/1.8 system-ui;background:#0f1b2a;border:1px solid #213247;border-radius:999px;padding:2px 10px;color:#a9c4e0}
    .row{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    button, .btn{background:#2b8cff;border:0;color:#fff;font-weight:800;letter-spacing:.02em;padding:12px 16px;border-radius:12px;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .muted{opacity:.75}
    .value{font-size:46px;font-weight:900;margin:10px 0 6px}
    .card{background:#0f1621;border:1px dashed #203045;border-radius:14px;padding:16px;margin-top:16px}
    a.btn {text-decoration:none;display:inline-block}
    .grid{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="hdr">
        <div class="title">IRON HAUL — Credits Console</div>
        <span class="badge" id="who">logged out</span>
      </div>

      <div class="grid">
        <div>
          <div class="muted">IH Balance</div>
          <div class="value" id="bal">—</div>
          <div class="muted mono" id="status">Ready</div>
        </div>
        <div class="row">
          <button id="refreshBtn">Refresh</button>
          <a class="btn" href="./buy-500.html" id="buyBtn">Buy 500 IH</a>
          <button id="loginBtn" style="background:#374a60">Log in</button>
          <button id="logoutBtn" style="background:#5a2d2d">Log out</button>
        </div>
      </div>

      <div class="card">
        <div class="muted">
          After paying, click <b>Refresh</b> to update your balance.
          Purchases open Thirdweb checkout in a new tab and include your
          <span class="mono">playerId</span> in metadata automatically.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ================== CONFIG ===================
    const TITLE_ID = "1A7FA4"; // e.g. 1A7FA4
    PlayFab.settings.titleId = TITLE_ID;
    // =============================================

    const elWho = document.getElementById("who");
    const elBal = document.getElementById("bal");
    const elStatus = document.getElementById("status");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    function setStatus(s){ elStatus.textContent = s; }
    function setWho(id){ elWho.textContent = id ? ("PlayFabId " + id) : "logged out"; }

    function getStoredId(){
      return localStorage.getItem("ih_playfab_id") || null;
    }
    function setStoredId(id){
      if (id) localStorage.setItem("ih_playfab_id", id);
      else localStorage.removeItem("ih_playfab_id");
      setWho(id);
      window.currentPlayFabId = id || undefined;
    }

    // Simple demo login using CustomID. Replace with your real auth.
    function makeCustomId(){
      const key="ih_custom_id"; let v=localStorage.getItem(key);
      if(!v){ v="guest_"+crypto.randomUUID(); localStorage.setItem(key,v); }
      return v;
    }

    async function login(){
      setStatus("Logging in…");
      loginBtn.disabled=true;
      try{
        const body = {
          TitleId: TITLE_ID,
          CustomId: makeCustomId(),
          CreateAccount: true
        };
        const res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/LoginWithCustomID`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        }).then(r=>r.json());
        const id = res?.data?.PlayFabId;
        if(!id) throw res;
        setStoredId(id);
        setStatus("Logged in.");
        await refreshBalance();
      }catch(e){
        console.error(e);
        setStatus("Login failed (see console).");
      }finally{
        loginBtn.disabled=false;
      }
    }

    function logout(){
      setStoredId(null);
      elBal.textContent = "—";
      setStatus("Logged out.");
    }

    async function refreshBalance(){
      const id = getStoredId();
      if(!id){ setStatus("Please log in to load balance."); return; }
      setStatus("Loading balance…");
      refreshBtn.disabled = true;
      try{
        // Get currency for the user (virtual currency code "IH")
        const res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/GetUserInventory`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ PlayFabId: id })
        }).then(r=>r.json());
        // Some titles track currency via "GetUserInventory" or "GetUserReadOnlyData".
        // If your title tracks currency elsewhere, adapt this call accordingly.
        const vc = res?.data?.VirtualCurrency || {};
        const amount = vc.IH ?? 0;
        elBal.textContent = amount;
        setStatus("Up to date.");
      }catch(e){
        console.error(e);
        setStatus("Failed to fetch balance (see console).");
      }finally{
        refreshBtn.disabled=false;
      }
    }

    // Wire up UI
    loginBtn.onclick = login;
    logoutBtn.onclick = logout;
    refreshBtn.onclick = refreshBalance;

    // Init
    setStoredId(getStoredId());
    if (getStoredId()) refreshBalance();
  </script>
</body>
</html>
