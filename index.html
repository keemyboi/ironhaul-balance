<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>IRON HAUL — Credits Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://1a7fa4.playfabapi.com" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1a2b;
      --ink: #d7e1ff;
      --muted: #8ba0c6;
      --ok: #5dd39e;
      --bad: #ff6b6b;
      --link: #5aa2ff;
      --btn: #2f78ff;
      --btn-alt: #1e2a42;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink);
      display: grid;
      place-items: center;
      min-height: 100vh;
    }
    .card {
      width: min(920px, 92vw);
      background: var(--panel);
      border-radius: 14px;
      box-shadow: 0 18px 30px rgba(0,0,0,.45);
      padding: 22px 22px 26px;
    }
    h1 {
      margin: 0 0 10px;
      font-size: 20px;
      letter-spacing: .2px;
    }
    .muted { color: var(--muted); }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .stat { font-size: 14px; margin: 8px 0 2px; }
    .stat strong { font-size: 40px; letter-spacing: .5px; }
    .pill { font-size: 12px; padding: 4px 10px; border-radius: 999px; background: #0c213e; color: var(--muted); }
    .pill small { opacity: .85; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      height: 38px; padding: 0 14px; border-radius: 10px;
      background: var(--btn); color: white; font-weight: 600;
      border: 0; cursor: pointer; text-decoration: none; outline: none;
    }
    .btn:hover { filter: brightness(1.08); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn.alt { background: var(--btn-alt); color: var(--ink); }
    .btn.bad { background: #6b1e1e; }
    code { background: #10223d; padding: .2em .5em; border-radius: 6px; color: #d5e2ff; }
    .hr { height: 1px; background: #162238; margin: 16px 0; opacity: .7; }
    .grow { flex: 1 }
  </style>
</head>
<body>
  <div class="card">
    <div class="row" style="justify-content:space-between; gap:10px">
      <h1>IRON HAUL — Credits Console</h1>
      <span class="pill"><small id="loginState">logged out</small></span>
    </div>

    <!-- Balance section (hidden until logged in) -->
    <div id="balWrap" style="display:none">
      <div class="stat muted">IH Balance</div>
      <div class="stat"><strong id="bal">—</strong></div>

      <div class="row" style="margin-top:12px">
        <button class="btn alt" id="refreshBtn">Refresh</button>
        <!-- RELATIVE links so GitHub Pages doesn't 404 -->
        <a class="btn" id="buy500Btn" href="buy-500.html">Buy 500 IH</a>
        <div class="grow"></div>
        <button class="btn bad" id="logoutBtn">Log out</button>
      </div>

      <p class="muted" style="margin-top:10px">
        After paying, click <b>Refresh</b> to update your balance.
        Purchases open Thirdweb checkout in a new tab and include your
        <code>playerId</code> in <code>metadata</code> automatically.
      </p>
    </div>

    <!-- Message shown when logged out -->
    <p id="loggedOutMsg" class="muted" style="margin: 6px 0 0">
      Log in to view your IH balance and purchase credits.
    </p>

    <div class="hr"></div>

    <div class="row">
      <!-- RELATIVE link to login page -->
      <a class="btn alt" href="login.html">Log in</a>
      <div id="status" class="muted" style="margin-left:8px">—</div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    // Change this if your title is different:
    const TITLE_ID = "1A7FA4"; // e.g. "1A7FA4"

    /***********************
     * STATE
     ***********************/
    let sessionTicket = localStorage.getItem("ih_session") || "";
    let playFabId     = localStorage.getItem("ih_playfab_id") || "";

    /***********************
     * DOM helpers
     ***********************/
    const $ = (sel) => document.querySelector(sel);
    function setText(id, text){ const el = typeof id === "string" ? document.getElementById(id) : id; if (el) el.textContent = text; }
    function show(el, on){ el.style.display = on ? "" : "none"; }
    function setStatus(msg, tone){
      const el = document.getElementById("status");
      el.textContent = msg;
      el.style.color = tone === "ok" ? "var(--ok)" : tone === "bad" ? "var(--bad)" : "var(--muted)";
    }

    function reflectLogin(){
      const loggedIn = !!sessionTicket && !!playFabId;
      setText("loginState", loggedIn ? `logged in as ${playFabId}` : "logged out");
      show(document.getElementById("balWrap"), loggedIn);
      show(document.getElementById("loggedOutMsg"), !loggedIn);
    }

    /***********************
     * API helpers
     ***********************/
    async function pf(path, body, opts = {}){
      const headers = {
        "Content-Type": "application/json",
        ...(opts.auth ? { "X-Authorization": sessionTicket } : {})
      };
      const res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/${path}`, {
        method: "POST",
        headers,
        body: JSON.stringify(body || {})
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.error) {
        const code = json?.errorCode || res.status;
        const name = json?.error || res.statusText;
        const msg  = json?.errorMessage || "Request failed";
        const err  = new Error(`${name} (${code}): ${msg}`);
        err.data = json;
        throw err;
      }
      return json;
    }

    async function refreshBalance(){
      if (!sessionTicket) { setStatus("Not logged in.", "bad"); return; }
      setStatus("Fetching balance…");
      try {
        const json = await pf("GetUserInventory", {}, { auth: true });
        const vc = json?.data?.VirtualCurrency || {};
        const ih = Number(vc["IH"] || 0);
        setText("bal", ih.toLocaleString());
        setStatus("Balance updated.", "ok");
      } catch (e) {
        const tooMany = e?.data?.status === "TooManyRequests" || e?.data?.errorCode === 1199;
        setStatus(tooMany ? "Throttled by PlayFab. Try again in a few seconds." : e.message, "bad");
      }
    }

    function logout(){
      sessionTicket = "";
      playFabId = "";
      localStorage.removeItem("ih_session");
      localStorage.removeItem("ih_playfab_id");
      setText("bal","—");
      reflectLogin();
      setStatus("Logged out.");
    }

    /***********************
     * Wire up UI
     ***********************/
    document.getElementById("refreshBtn").addEventListener("click", refreshBalance);
    document.getElementById("logoutBtn").addEventListener("click", logout);

    // Initial paint
    reflectLogin();
    if (sessionTicket && playFabId) {
      // Try to show balance immediately
      refreshBalance();
    } else {
      setStatus("Log in to view your balance.");
    }
  </script>
</body>
</html>
