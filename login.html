<script>
  const TITLE_ID = "1A7FA4"; // your title id
  PlayFab.settings.titleId = TITLE_ID;

  function getLocal(k){ try { return localStorage.getItem(k) || ""; } catch { return ""; } }
  function setLocal(k,v){ try { localStorage.setItem(k,v); } catch {} }

  function ensureCustomId() {
    let id = getLocal("ih_custom_id");
    if (!id) {
      id = (crypto && crypto.randomUUID) ? crypto.randomUUID()
                                         : ("ih_" + Math.random().toString(36).slice(2));
      setLocal("ih_custom_id", id);
    }
    return id;
  }

  let logging = false;

  async function login() {
    if (logging) return;             // debounce to avoid 429
    logging = true;
    const btn = document.getElementById("loginBtn");
    if (btn) btn.disabled = true;

    const customId = ensureCustomId();
    const body = {
      TitleId: TITLE_ID,
      CustomId: customId,
      CreateAccount: true,
      InfoRequestParameters: { GetUserAccountInfo: true },
    };

    let retryDelay = 0;

    try {
      while (true) {
        const res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/LoginWithCustomID`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          mode: "cors",
          body: JSON.stringify(body),
        });

        const data = await res.json();
        console.log("[IH] Login response:", data);

        if (res.ok && data.code === 200) {
          const id = data?.data?.PlayFabId;
          if (!id) throw new Error("No PlayFabId in response");
          window.currentPlayFabId = id;
          setLocal("ih_playfab_id", id);
          document.getElementById("status").textContent = `Logged in as ${id}`;
          document.getElementById("loggedState").textContent = "logged in";
          break;
        }

        // Handle common errors
        if (data?.error === "APIClientRequestRateLimitExceeded" || data?.status === "TooManyRequests") {
          // Respect server hint or backoff
          const hint = Number(data?.retryAfterSeconds) || 3;
          retryDelay = Math.max(retryDelay * 2, hint); // exponential-ish
          document.getElementById("status").textContent = `Throttled. Retrying in ${retryDelay}s…`;
          await new Promise(r => setTimeout(r, retryDelay * 1000));
          continue;
        }

        if (data?.error === "PlayerCreationDisabled" || data?.errorCode === 22000) {
          document.getElementById("status").textContent =
            "Player creation is disabled for this title. Enable it in PlayFab → Settings → API Features → Player Creation.";
          document.getElementById("loggedState").textContent = "logged out";
          break;
        }

        // Other errors
        document.getElementById("status").textContent =
          `Login failed: ${data?.errorMessage || data?.error || "See console"}`;
        document.getElementById("loggedState").textContent = "logged out";
        break;
      }
    } catch (err) {
      console.error("[IH] Login failed:", err);
      document.getElementById("status").textContent = "Login failed (see console).";
      document.getElementById("loggedState").textContent = "logged out";
    } finally {
      if (btn) btn.disabled = false;
      logging = false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("loginBtn");
    if (btn) btn.addEventListener("click", login);

    const saved = getLocal("ih_playfab_id");
    if (saved) {
      window.currentPlayFabId = saved;
      document.getElementById("status").textContent = `Logged in as ${saved}`;
      document.getElementById("loggedState").textContent = "logged in";
    }
  });
</script>
