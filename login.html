<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Log in ‚Ä¢ IRON HAUL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg:#0b1220; --panel:#0f1a2b; --ink:#d7e1ff; --muted:#8ba0c6;
      --btn:#2f78ff; --btn-alt:#1e2a42; --ok:#5dd39e; --bad:#ff6b6b; --focus:#2a5bff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      min-height:100vh; display:grid; place-items:center;
    }
    .card{
      width:min(520px,92vw); background:var(--panel); color:var(--ink);
      border-radius:14px; padding:22px 22px 24px; box-shadow:0 18px 30px rgba(0,0,0,.45)
    }
    h1{margin:0 0 10px; font-size:20px}
    .muted{color:var(--muted)}
    .tabs{display:flex; gap:6px; margin:10px 0 14px}
    .tab{
      flex:1; height:38px; border-radius:10px; background:#0e1a2f; color:var(--ink);
      border:1px solid #1b2a44; display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none; font-weight:600
    }
    .tab.active{background:#173157; border-color:var(--focus)}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    input{
      width:100%; height:40px; border-radius:10px; border:1px solid #1b2a44;
      padding:0 12px; color:var(--ink); background:#0e1a2f; outline:none
    }
    input:focus{border-color:var(--focus)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:40px; padding:0 14px; border-radius:10px; border:0; cursor:pointer;
      background:var(--btn); color:#fff; font-weight:600; text-decoration:none
    }
    .btn.alt{background:var(--btn-alt); color:var(--ink)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .hr{height:1px; background:#162238; opacity:.7; margin:16px 0}
    .status{margin-top:10px; font-size:14px}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .toggle-eye{position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:var(--muted)}
    .field{position:relative}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="card">
    <h1>Log in to IRON HAUL</h1>
    <p class="muted" style="margin-top:0">
      Use the same credentials your game already created.<br/>
      Website login never creates accounts.
    </p>

    <!-- tabs -->
    <div class="tabs">
      <div class="tab active" id="tab-custom">Custom ID</div>
      <div class="tab" id="tab-email">Email &amp; Password</div>
    </div>

    <!-- Custom ID form -->
    <section id="form-custom">
      <label for="customId">Custom ID</label>
      <input id="customId" autocomplete="off" placeholder="Enter your PlayFab CustomID" />
      <div class="hint">Your game usually shows or stores this ID for you.</div>

      <div class="row" style="margin-top:14px">
        <button class="btn" id="loginCustomBtn">Log in</button>
        <a class="btn alt" href="index.html">Cancel</a>
      </div>
    </section>

    <!-- Email/Password form -->
    <section id="form-email" class="hide">
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@example.com" />

      <label for="password">Password</label>
      <div class="field">
        <input id="password" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <span id="togglePwd" class="toggle-eye" title="Show/Hide">üëÅ</span>
      </div>

      <div class="hint">Account must already exist (created in-game). No sign-ups on the website.</div>

      <div class="row" style="margin-top:14px">
        <button class="btn" id="loginEmailBtn">Log in</button>
        <a class="btn alt" href="index.html">Cancel</a>
      </div>
    </section>

    <div class="status muted" id="status">‚Äî</div>

    <div class="hr"></div>
    <p class="muted" style="margin:0">
      After login you‚Äôll return to the console to view your balance.
    </p>
  </div>

  <script>
    /******** CONFIG ********/
    const TITLE_ID = "1A7FA4"; // <- change if different

    /******** DOM helpers ********/
    const $ = (s)=>document.querySelector(s);
    function status(msg, tone){
      const el=$("#status"); el.textContent=msg;
      el.style.color = tone==="ok" ? "var(--ok)" : tone==="bad" ? "var(--bad)" : "var(--muted)";
    }
    function setTab(which){
      const customActive = (which==="custom");
      $("#tab-custom").classList.toggle("active", customActive);
      $("#tab-email").classList.toggle("active", !customActive);
      $("#form-custom").classList.toggle("hide", !customActive);
      $("#form-email").classList.toggle("hide", customActive);
    }
    $("#tab-custom").onclick = ()=>setTab("custom");
    $("#tab-email").onclick  = ()=>setTab("email");

    // show/hide password
    $("#togglePwd").onclick = ()=>{
      const i=$("#password");
      i.type = i.type==="password" ? "text" : "password";
    };

    function nextUrl(){
      const u=new URL(location.href);
      const n=u.searchParams.get("next");
      // safe relative path only
      if (n && /^\/[^?#]*/.test(n)) return n;
      return "/ironhaul-balance/"; // repo root (works on GH Pages)
    }

    async function pf(path, body){
      const res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/${path}`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body||{})
      });
      const json = await res.json().catch(()=>({}));
      if(!res.ok || json.error){
        const code=json?.errorCode||res.status, name=json?.error||res.statusText, msg=json?.errorMessage||"Request failed";
        const err=new Error(`${name} (${code}): ${msg}`); err.data=json; throw err;
      }
      return json;
    }

    function saveSession(json){
      const st = json?.data?.SessionTicket;
      const pid = json?.data?.PlayFabId;
      if (!st || !pid) throw new Error("Invalid login response");
      localStorage.setItem("ih_session", st);
      localStorage.setItem("ih_playfab_id", pid);
    }

    /******** Custom ID login ********/
    $("#loginCustomBtn").addEventListener("click", loginWithCustom);
    $("#customId").addEventListener("keydown", e=>{ if(e.key==="Enter") loginWithCustom(); });

    async function loginWithCustom(){
      const id = $("#customId").value.trim();
      if (!id){ status("Enter your Custom ID.", "bad"); return; }
      $("#loginCustomBtn").disabled = true;
      status("Signing in‚Ä¶");
      try{
        // Website NEVER creates accounts:
        const json = await pf("LoginWithCustomID",{ TitleId:TITLE_ID, CustomId:id, CreateAccount:false });
        saveSession(json);
        status("Logged in. Redirecting‚Ä¶", "ok");
        setTimeout(()=>location.replace(nextUrl()), 350);
      }catch(e){
        const d=e?.data||{};
        const code=d?.errorCode||"", name=d?.error||e.name, msg=d?.errorMessage||e.message;
        if (code===22000 || name==="AccountNotFound" || name==="InvalidParams"){
          status("Account not found for this Custom ID. Use the exact one from your game.", "bad");
        } else if (code===1199 || d?.status==="TooManyRequests"){
          status("Throttled by PlayFab. Please wait a few seconds and try again.", "bad");
        } else {
          status(`${name}: ${msg}`, "bad");
        }
      }finally{
        $("#loginCustomBtn").disabled = false;
      }
    }

    /******** Email & Password login ********/
    $("#loginEmailBtn").addEventListener("click", loginWithEmail);
    $("#email").addEventListener("keydown", e=>{ if(e.key==="Enter") loginWithEmail(); });
    $("#password").addEventListener("keydown", e=>{ if(e.key==="Enter") loginWithEmail(); });

    async function loginWithEmail(){
      const email = $("#email").value.trim();
      const pwd   = $("#password").value;
      if (!email || !pwd){ status("Enter email and password.", "bad"); return; }

      $("#loginEmailBtn").disabled = true;
      status("Signing in‚Ä¶");

      try{
        // NOTE: LoginWithEmailAddress has no CreateAccount flag. Account must pre-exist.
        const json = await pf("LoginWithEmailAddress", { TitleId: TITLE_ID, Email: email, Password: pwd });
        saveSession(json);
        status("Logged in. Redirecting‚Ä¶", "ok");
        setTimeout(()=>location.replace(nextUrl()), 350);
      }catch(e){
        const d=e?.data||{};
        const code=d?.errorCode||"", name=d?.error||e.name, msg=d?.errorMessage||e.message;
        if (name==="InvalidEmailOrPassword" || code===passwordWrongCode()){
          status("Invalid email or password.", "bad");
        } else if (code===1199 || d?.status==="TooManyRequests"){
          status("Throttled by PlayFab. Please wait a few seconds and try again.", "bad");
        } else if (name==="AccountNotFound" || code===22000){
          status("Account not found. Email login requires an existing account created in-game.", "bad");
        } else {
          status(`${name}: ${msg}`, "bad");
        }
      }finally{
        $("#loginEmailBtn").disabled = false;
      }
    }

    // Some PlayFab SDKs use different numeric codes; keep this helper in case you want to tweak:
    function passwordWrongCode(){
      // return official code if you use it; using a placeholder keeps comparison harmless
      return -99999;
    }
  </script>
</body>
</html>
